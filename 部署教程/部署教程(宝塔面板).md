# åŸºäºå®å¡”é¢æ¿çš„éƒ¨ç½²æ•™ç¨‹

ç†è®ºä¸Šï¼Œåªè¦ä½ çš„æœåŠ¡å™¨ã€è™šæ‹Ÿä¸»æœºæœ‰ç›¸åº”çš„ç¯å¢ƒï¼Œå°±èƒ½éƒ¨ç½²ï¼Œä½ å¯ä»¥éƒ¨ç½²åœ¨å„ç§é¢æ¿çš„è™šæ‹Ÿä¸»æœº(`Kangle`ã€**å®å¡”**ç­‰)æˆ–æœåŠ¡å™¨ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºäº**å®å¡”é¢æ¿**çš„éƒ¨ç½²æ•™ç¨‹

> å¯æ­é…[è§†é¢‘](https://www.bilibili.com/video/BV1j14y1r7W6?p=3)ä¸€èµ·é£Ÿç”¨

## å‡†å¤‡

- é¦–å…ˆï¼Œä½ çš„æœ‰å°å®‰è£…äº†**å®å¡”é¢æ¿**çš„æœåŠ¡å™¨(å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥å…³é—­è¯¥æ–‡æ¡£äº†å‘¢ğŸ˜)
- æ¥ç€ï¼Œç”¨**æµè§ˆå™¨**è®¿é—®ä½ çš„**å®å¡”é¢æ¿**ï¼Œç¡®ä¿ä½ çš„é¢æ¿å®‰è£…æœ‰ä»¥ä¸‹ç¯å¢ƒ
  - `Nginx`æœåŠ¡å™¨
  - `PHP`ç¯å¢ƒï¼Œç‰ˆæœ¬éœ€`8+`
    - å¹¶è‡³å°‘éœ€å®‰è£…æœ‰`fileinfo`æ‰©å±•ï¼Œä¸ºäº†æ»¡è¶³æ–‡ä»¶ä¸Šä¼ éœ€æ±‚
  - `MySql`æ•°æ®åº“ï¼Œç‰ˆæœ¬éœ€`8+`
  - `PureFTPd`ï¼Œç”¨äº`FTP`ä¸Šä¼ æºç æ–‡ä»¶
  - å¦‚æœä¸çŸ¥é“è‡ªå·±å®‰è£…äº†ä»€ä¹ˆç¯å¢ƒï¼Œå¯ä»¥ç‚¹å‡»**è½¯ä»¶å•†åº—/å·²å®‰è£…**æŸ¥çœ‹

## åˆ›å»ºç«™ç‚¹

> éƒ¨ç½²çš„æ–¹æ³•æœ‰å¾ˆå¤š
>
> - å¯ä»¥å‰ç«¯ç•Œé¢(`front`)ã€åç«¯ç®¡ç†ç•Œé¢(`admin`)å’Œåç«¯æ¥å£é¡¹ç›®(`backend`)å„ç”¨ä¸€ä¸ªç«™ç‚¹æˆ–ç”¨ä¸åŒæœåŠ¡å™¨éƒ¨ç½²ï¼Œè¾ƒä¸ºå®‰å…¨
> - ä¹Ÿå¯ä»¥å…¨éƒ¨éƒ¨ç½²åœ¨ä¸€ä¸ªç«™ç‚¹ï¼Œé›†ä¸­éƒ¨ç½²ï¼Œè¾ƒä¸ºæ–¹ä¾¿
>
> è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†æ•™ç¨‹ï¼Œé‡‡ç”¨ä¸€ä¸ªç«™ç‚¹å…¨éƒ¨ç½²ï¼Œä»¥æ–¹ä¾¿ä¸ºä¸»ï¼Œä½†åŸç†æ˜¯ä¸€æ ·çš„ï¼Œé‡‡ç”¨å¤šç«™ç‚¹éƒ¨ç½²å°±æ˜¯å…³é”®çš„è¯·æ±‚åœ°å€éœ€ç›¸åº”æ›´æ”¹ç½¢äº†

- åˆ›å»ºä¸€ä¸ªç«™ç‚¹
  - å¦‚å¡«å†™åŸŸåï¼Œéœ€è§£æåˆ°ç«™ç‚¹æ‰€åœ¨æœåŠ¡å™¨`ip`
  - å¦‚æ²¡æœ‰åŸŸåï¼Œå¯ç›´æ¥å¡«å†™ç«™ç‚¹æ‰€åœ¨æœåŠ¡å™¨`ip`
  - `FTP`å¯é¡ºä¾¿åˆ›å»ºï¼Œç”¨äºä¸Šä¼ æºç æ–‡ä»¶
  - æ•°æ®åº“æ²¡æœ‰ä¹Ÿå¯é¡ºä¾¿åˆ›å»º
  - å†…å®¹éœ€æ ¹æ®è‡ªå·±æƒ…å†µåŠ¨æ€æ›´æ”¹

![image-20240218184801626](https://static.ltgcm.top/md/20240218184806.png)

## ç«™ç‚¹é…ç½®

ä¸»è¦éœ€é…ç½®å¦‚ä¸‹ä¼ªé™æ€è§„åˆ™

```nginx
# æ¥å£è½¬å‘
location /api {
	if (!-f $request_filename) {
		rewrite  ^/api/(.*)$  /backend/public/index.php/$1  last;
	}
}
# æ–‡ç« è½¬å‘
location /article {
	if (!-f $request_filename) {
		rewrite  ^/article/(.*)$  /api/article/$1  last;
	}
}
# æœ¬åœ°å­˜å‚¨è½¬å‘
location ~ /oss {
	if (!-f $request_filename) {
		rewrite  ^/oss/(.*)$  /backend/public/storage/$1  last;
	}
}
# é™æ€èµ„æºè½¬å‘
location ~ /static {
	if (!-f $request_filename) {
		rewrite  ^/static/(.*)$  /backend/public/static/$1  last;
	}
}
# ä¸Šä¼ æ–‡ä»¶ç¼“å­˜åœ°å€è½¬å‘
location ~ /tmp {
	if (!-f $request_filename) {
		rewrite  ^/tmp/(.*)$  /backend/public/tmp/$1  last;
	}
}
# adminï¼ŒåŒä¸€ç«™ç‚¹éƒ¨ç½²éœ€è¦ï¼Œä¿è¯å•é¡µé¢åº”ç”¨åˆ·æ–°æ— è¯¯
location /admin {
	if (!-f $request_filename) {
		rewrite  ^/admin/(.*)$  /admin/index.html  last;
	}
}
```

- `backend`ä¸ºç«™ç‚¹å†…åç«¯é¡¹ç›®æ‰€åœ¨ç›®å½•

- ![image-20240223185041383](https://static.ltgcm.top/md/20240223185044.png)

## åˆ›å»ºæ•°æ®åº“

å¦‚åˆ›å»ºç«™ç‚¹æ—¶å·²ç»åˆ›å»ºï¼Œè¿™é‡Œåˆ™æ— éœ€é‡å¤åˆ›å»º

![image-20240218190405685](https://static.ltgcm.top/md/20240218190409.png)

- å¯¼å…¥æ•°æ®åº“è¡¨ç­‰ä¿¡æ¯

  - æ•°æ®åº“æ–‡ä»¶ä½äº`/sql/release.sql`

  - å¯æ‰“å¼€æ»‘åˆ°æ–‡ä»¶æœ«å°¾ï¼Œä¿®æ”¹åå°ç®¡ç†ç”¨æˆ·åˆå§‹è´¦å·å¯†ç 

    - ```mysql
      -- ----------------------------
      -- Records of role
      -- æ ¹ç”¨æˆ·ï¼šå¯è‡ªè¡Œè®¾ç½®ä»¥ä¸‹å€¼ï¼Œå¦‚æ˜¯ä¸Šçº¿é¡¹ç›®ï¼Œå»ºè®®ä¸ç”¨è®¾ç½®è¿‡ç®€å•ï¼›ä¹Ÿå¯åæœŸæ‰“å¼€æ•°æ®åº“ä¿®æ”¹
      -- username: root_admin
      -- password: 123456ï¼ˆmd5åŠ å¯†ï¼‰
      -- ----------------------------
      INSERT INTO `role` VALUES (14762905601838761, 'root_admin', MD5(123456), 0, 0, '2023-08-16 17:45:57', '2023-08-16 17:45:57');
      ```

    - ä¿®æ”¹å…¶ä¸­çš„`root_admin`å’Œ`123456`

    - è¯¥å€¼ä¸ºéƒ¨ç½²å®Œæˆåç™»å½•åå°éœ€è¦

![image-20240218190524727](https://static.ltgcm.top/md/20240218190528.png)

- ç‚¹å‡»å¯¼å…¥ï¼Œå°†`sql`æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨

![image-20240223190132924](https://static.ltgcm.top/md/20240223190136.png)

- å¯¼å…¥æˆåŠŸåï¼Œå¦‚éœ€æŸ¥çœ‹æ•°æ®åº“è¡¨æ•°æ®ï¼Œå¯åœ¨æœåŠ¡å™¨æ‰“å¼€ç»ˆç«¯ï¼Œç”¨å‘½ä»¤è¡Œæ¨¡å¼æŸ¥çœ‹ï¼›ä¹Ÿå¯åœ¨æœ¬åœ°ç”µè„‘ï¼Œç”¨`navicat`æˆ–å…¶å®ƒè½¯ä»¶è¿œç¨‹è¿æ¥æŸ¥çœ‹

## æºç æ‰“åŒ…

å°†é¡¹ç›®æºç å…‹éš†åˆ°æœ¬åœ°åï¼Œå†…å®¹å¦‚ä¸‹

![image-20240223205615760](https://static.ltgcm.top/md/20240223205620.png)

> ä¸»è¦éœ€å…³æ³¨ä»¥ä¸‹ç›®å½•
>
> - `admin` â€” åç«¯ç®¡ç†ç•Œé¢
> - `front` â€” å‰ç«¯ç•Œé¢
> - `backend` â€” åç«¯æ¥å£é¡¹ç›®

## éƒ¨ç½²åç«¯é¡¹ç›®

>  åˆšåˆ›å»ºå¥½çš„ç«™ç‚¹å†…ä¸€èˆ¬é»˜è®¤ä¼šæœ‰`index.html`ã€`404.html`ã€`.htaccess`ã€`.user.ini`è¿™`4`ä¸ªæ–‡ä»¶(å®å¡”ç‰ˆæœ¬ä¸åŒå¯èƒ½å­˜åœ¨å·®å¼‚)ï¼Œå°†`index.html`ã€`404.html`åˆ é™¤

- åœ¨ç«™ç‚¹æ ¹ç›®å½•(æˆ‘è¿™é‡Œä¸º`/www/release`ï¼Œå¯¹åº”åˆ›å»ºç«™ç‚¹æ—¶è®¾ç½®çš„æ ¹ç›®å½•)å†…ï¼Œåˆ›å»º`backend`ç›®å½•(åç§°éšæ„ï¼Œä½†å¦‚æ›´æ”¹äº†åé¢éœ€åŠ¨æ€å˜åŒ–)

- å°†æºç ä¸Šä¼ è‡³åˆšåˆ›å»ºçš„ç›®å½•
  - ![image-20240223211550455](https://static.ltgcm.top/md/20240223211554.png)
- é»˜è®¤ä¸Šä¼ åç›®å½•æƒé™æ‰€æœ‰è€…ä¸º`root`ï¼Œä¸ºäº†åç»­æ–¹ä¾¿ï¼Œå¯å°†`backend`æå…¶å­ç›®å½•çš„æƒé™è®¾ç½®ä¸º`755`ï¼Œæ‰€æœ‰è€…ä¸º`www`
  - è®¾ç½®æƒé™å¯ç‚¹å‡»ç›®å½•å³ä¾§çš„æƒé™å­—æ ·æŒ‰é’®
  - ![image-20240223213318424](https://static.ltgcm.top/md/20240223213321.png)
- ä¸ºé¡¹ç›®å®‰è£…ä¾èµ–
  - ç‚¹å‡»ç«™ç‚¹è®¾ç½®
  - ![image-20240223214919985](https://static.ltgcm.top/md/20240223214923.png)
  - å®‰è£…å®Œæˆåï¼Œåœ¨`backend`ç›®å½•ä¸‹ä¼šæ–°å¢ä¸€ä¸ª`vendor`ç›®å½•ï¼Œå³ä¸ºå®‰è£…æˆåŠŸ
- é…ç½®ç›¸å…³é¡¹
  - é…ç½®`.env`
    
      - å°†`backend`ç›®å½•ä¸‹çš„`.example.env`æ–‡ä»¶é‡å‘½åä¸º`.env`
      - å¹¶å°†å…¶ä¸­çš„å†…å®¹æ›¿æ¢ä¸ºè‡ªå·±çš„
        - ![image-20240223215757190](https://static.ltgcm.top/md/20240223215800.png)
  - é…ç½®`config`
      - æ‰“å¼€`/backend/config/common.php`
      - ![image-20240223220301711](https://static.ltgcm.top/md/20240223220305.png)
      - å°†å›¾ç‰‡å†…çº¢æ¡†æ ‡å‡ºå†…å®¹æ›´æ”¹ä¸ºè‡ªå·±éƒ¨ç½²çš„ç«™ç‚¹åŸŸåï¼Œè¿™é‡Œæ”¹ä¸º`release.skmcj.top`
      - ![image-20240223222557287](https://static.ltgcm.top/md/20240223222600.png)

åšå®Œä»¥ä¸Šæ­¥éª¤ï¼Œåç«¯é¡¹ç›®åŸºæœ¬å°±éƒ¨ç½²å¥½äº†ï¼Œæ­¤æ—¶å¯è®¿é—®ä¸‹`API`æµ‹è¯•ä¸‹ï¼Œå¦‚`https://release.skmcj.top/api/sentence/daily`



## æ‰“åŒ…å‰ç«¯ç•Œé¢

æ‰“åŒ…å‰ç«¯ç•Œé¢ï¼Œéœ€ä¿è¯æœ¬åœ°æœ‰`node`ç¯å¢ƒ

- è¿›å…¥`front`ç›®å½•
- åˆ›å»ºå¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶
  - `.env.development` â€” å¼€å‘ç¯å¢ƒï¼Œå³è¿è¡Œè°ƒè¯•æ—¶ä½¿ç”¨çš„ç¯å¢ƒ
  - `.env.production` â€” ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼Œå³æ‰“åŒ…æ—¶ä½¿ç”¨çš„ç¯å¢ƒ
  - åœ¨åˆ›å»ºçš„æ–‡ä»¶å†…æ·»åŠ `VITE_BASE_URL='https://release.skmcj.top/api'`ï¼Œå€¼éœ€æ ¹æ®è‡ªå·±éƒ¨ç½²ç¯å¢ƒåŠ¨æ€æ›´æ”¹
- åœ¨å½“å‰ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯çª—å£ï¼Œè¿è¡Œ`npm install`å®‰è£…ä¾èµ–
- æ¥ç€è¿è¡Œ`npm run build`æ‰“åŒ…æ„å»ºï¼ŒæˆåŠŸåä¼šç”Ÿæˆä¸€ä¸ª`dist`æ–‡ä»¶å¤¹ï¼Œé‡Œé¢å³ä¸ºæ‰“åŒ…åçš„æ–‡ä»¶
  - ä¹Ÿå¯è¿è¡Œ`npm run dev`è¿è¡Œï¼Œåœ¨æœ¬åœ°å…ˆè°ƒè¯•æµ‹è¯•ä¸€ç•ªï¼Œæ— è¯¯å†æ‰“åŒ…


> æ‰“åŒ…åç«¯ç•Œé¢é¡¹ç›®(`admin`)æ“ä½œä¸ä»¥ä¸Šç±»ä¼¼ï¼Œä¸å†å¤è¿°

## éƒ¨ç½²å‰ç«¯é¡¹ç›®

- å°†`front`æ‰“åŒ…åçš„æ–‡ä»¶(å³ä¸º`dist`å†…çš„å†…å®¹)ä¸Šä¼ è‡³ç«™ç‚¹ç›®å½•ä¸‹
- åœ¨ç«™ç‚¹ç›®å½•ä¸‹æ–°å»º`admin`ç›®å½•ï¼Œå°†`admin`æ‰“åŒ…åçš„æ–‡ä»¶ä¸Šä¼ è‡³è¯¥ç›®å½•
- ä¸Šä¼ å®Œæˆåçš„ç›®å½•ç»“æ„å¦‚ä¸‹
  - ![image-20240223225334453](https://static.ltgcm.top/md/20240223225338.png)

> åšå®Œæ­¤æ­¥ï¼Œé¡¹ç›®åŸºæœ¬å°±é…ç½®å®Œæˆ
>
> æ­¤æ—¶ï¼š
>
> - è®¿é—®`https://release.skmcj.top`å³å¯è®¿é—®ç½‘ç«™
> - è®¿é—®`https://release.skmcj.top/admin`å³å¯è®¿é—®åç«¯ç®¡ç†ç½‘ç«™
> - ä»¥ä¸Šç½‘ç«™ä»…ä¸ºç¤ºä¾‹ï¼Œå…·ä½“éœ€æ ¹æ®è‡ªå·±éƒ¨ç½²çš„æ¥

## ç–‘éš¾æ‚é—®

ä»¥ä¸‹åˆ—å‡ºä¸€äº›å¯èƒ½çš„é—®é¢˜è§£ç­”ï¼Œä¸»è¦é’ˆå¯¹çš„æ˜¯ç”±äºæœåŠ¡å™¨ç¯å¢ƒå¼•å‘çš„é”™è¯¯ï¼Œä»¥ä¸‹é—®é¢˜å‰å¸¦æœ‰`[APP_DEBUG]`çš„è¡¨ç¤ºéœ€æ‰“å¼€`APP_DEBUG`æ¨¡å¼æ‰èƒ½çœ‹åˆ°çš„ä¿¡æ¯

- å½“è¯·æ±‚æŠ¥é”™ï¼Œä¸”ä¸ºæœªçŸ¥é”™è¯¯æ—¶ï¼Œå¦‚éœ€è°ƒè¯•æŸ¥çœ‹æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
  - æ‰“å¼€`backend`ç›®å½•ä¸‹çš„`.env`æ–‡ä»¶ï¼Œå¯ç”¨æˆ–æ·»åŠ `APP_DEBUG = true`
  
- `[APP_DEBUG]`æŸ¥çœ‹/æ‰“å¼€æ–‡ç« å†…å®¹é¡µï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤ºç±»ä¼¼`%E6%B5%8B%E8%AFÂ·Â·Â·`çš„`URL`ä¸­æ–‡ç¼–ç å€¼ï¼Œå¦‚ä¸‹å›¾
  
  - ![image-20240223171438226](https://static.ltgcm.top/md/20240223171442.png)
  - è¯¥é—®é¢˜ä¸»è¦æ˜¯ç”±äºè·¯ç”±è·¯å¾„åŒ…å«ä¸­æ–‡ï¼Œè¢«`URL`ç¼–ç åï¼Œè·¯ç”±æ— æ³•æ­£å¸¸åŒ¹é…å¯¼è‡´
  - å¯åœ¨`/backend/route/app.php`å†…ï¼Œä¿®æ”¹æ–‡ç« è·å–è·¯ç”±`Route::get('article/:name', 'Article/getProfile');`ä¸º`Route::get('article/:name', 'Article/getProfile') -> pattern(['name' => '\S+']);`
  
- `[APP_DEBUG]`ä¸Šä¼ å›¾ç‰‡æ¥å£æ—¶æŠ¥é”™`Class 'finfo' not found`

  - è¯¥é”™è¯¯ä¸»è¦ä¸º`php`æœªå®‰è£…`fileinfo`æ‰©å±•å¯¼è‡´ï¼Œå»`php`è®¾ç½®ç•Œé¢å®‰è£…å³å¯

- `[APP_DEBUG]`ä¸Šä¼ å›¾ç‰‡åä¿å­˜ä¿¡æ¯(å¦‚æ–°å¢æ–‡ç« ä¿¡æ¯ï¼Œä¸Šä¼ å°é¢åä¿å­˜)ï¼ŒæŠ¥`permission denied`æƒé™ä¸è¶³é—®é¢˜

  - è¿™æ˜¯ç”±äºæœåŠ¡å™¨é»˜è®¤æƒé™ä¸ä¸Šä¼ æ–‡ä»¶ä¿å­˜æ—¶è¿ç®—ï¼Œå¯¼è‡´å›¾ç‰‡ä¸´æ—¶ä¿å­˜çš„æƒé™ä¸è¶³ï¼Œæ­£å¸¸éœ€ä¸º`755`

  - å¯ä¿®æ”¹`/backend/app/controller/ArticleController.php`å†…`upload`æ–¹æ³•

    - ```php
      /**
       * ä¸Šä¼ å›¾ç‰‡
       * è¿”å›å›¾ç‰‡ä¸´æ—¶è·¯å¾„
       */
      public function upload() {
          if($this -> request -> isPost()) {
              // ä¸Šä¼ å¯¹è±¡
              $file = $this -> request -> file();
              // å›¾ç‰‡é™åˆ¶å°ºå¯¸ 5m
              $size = 5 * 1024 * 1024;
              try {
                  // éªŒè¯
                  validate(['image' => "fileSize:{$size}|fileExt:jpg,jpeg,png,gif"]) -> check($file);
                  // ä¿å­˜å›¾ç‰‡åˆ°ä¸´æ—¶è·¯å¾„
                  $saveName = Filesystem::disk('tmp') -> putFile('image', $file['image'], function () use ($file) {
                      $img = $file['image'];
                      $dir = date('Ymd');
                      $name = $img -> md5();
                      return "{$dir}/{$name}";
                  });
                  
                  /** æ–°å¢ä»£ç  */
                  // å°†åˆšä¿å­˜çš„å›¾ç‰‡æƒé™æ›´æ”¹ä¸º755
                  $path = Filesystem::disk('tmp')->path($saveName);
                  chmod($path, 0755);
                  /** end */
                  
                  // å›¾ç‰‡å¯¹è±¡
                  $img = ImageEntity::parseFile($file['image'], $saveName, 'tmp');
                  // è¿”å›ä¿å­˜æ–‡ä»¶
                  return result()::success($img);
              } catch (ValidateException $e) {
                  return result()::error(431, $e -> getMessage());
              }
          } else {
              return result()::error(Status::IMG_RQM_ERR());
          }
      }
      ```

## Tip

ä»¥ä¸ŠåŸŸå(`release.skmcj.top`)ä»…æµ‹è¯•ä½¿ç”¨ï¼Œå¤§å®¶ä¸éœ€è¦å»å°è¯•è®¿é—®`[ä½ æ‡‚çš„]`
